{% extends "base.html" %}

{% block title %}Editar Manuten√ß√£o - Sistema de Manuten√ß√£o{% endblock %}

{% block header_title %}Editar Manuten√ß√£o{% endblock %}

{% block content %}
<div class="container">
    <div class="card">
        <div class="card-header">
            <h2>‚úèÔ∏è Editar Manuten√ß√£o</h2>
        </div>
        <div class="card-body">
            <form method="POST" enctype="multipart/form-data">
                <!-- Tipo (readonly) -->
                <div class="form-group">
                    <label for="tipo">üè∑Ô∏è Tipo de Manuten√ß√£o</label>
                    <input type="text" id="tipo" value="{% if manutencao.tipo == 'loja' %}üè™ Loja{% else %}üöó Ve√≠culo{% endif %}" readonly class="form-control">
                </div>

                <!-- T√≠tulo -->
                <div class="form-group">
                    <label for="titulo">üìù T√≠tulo *</label>
                    <input type="text" id="titulo" name="titulo" value="{{ manutencao.titulo }}" required class="form-control">
                </div>

                <!-- Data -->
                <div class="form-group">
                    <label for="data_manutencao">üìÖ Data da Manuten√ß√£o</label>
                    <input type="date" id="data_manutencao" name="data_manutencao" 
                           value="{{ manutencao.data_manutencao.strftime('%Y-%m-%d') }}" class="form-control">
                </div>

                <!-- Loja ou Ve√≠culo -->
                {% if manutencao.tipo == 'loja' %}
                <div class="form-group">
                    <label for="loja_id">üè™ Loja</label>
                    <select id="loja_id" name="loja_id" class="form-control">
                        <option value="">Selecione uma loja</option>
                        {% for loja in lojas %}
                        <option value="{{ loja.id }}" {% if manutencao.loja_id == loja.id %}selected{% endif %}>
                            {{ loja.nome }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                {% else %}
                <div class="form-group">
                    <label for="veiculo_id">üöó Ve√≠culo</label>
                    <select id="veiculo_id" name="veiculo_id" class="form-control">
                        <option value="">Selecione um ve√≠culo</option>
                        {% for veiculo in veiculos %}
                        <option value="{{ veiculo.id }}" {% if manutencao.veiculo_id == veiculo.id %}selected{% endif %}>
                            {{ veiculo.placa }} - {{ veiculo.modelo }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                {% endif %}

                <!-- Descri√ß√£o -->
                <div class="form-group">
                    <label for="descricao">üìÑ Descri√ß√£o</label>
                    <textarea id="descricao" name="descricao" rows="4" class="form-control" placeholder="Descreva os detalhes da manuten√ß√£o...">{{ manutencao.descricao }}</textarea>
                </div>

                <!-- Pre√ßo -->
                <div class="form-group">
                    <label for="preco_total">üí∞ Pre√ßo Total (R$)</label>
                    <input type="number" id="preco_total" name="preco_total" step="0.01" min="0" 
                           value="{{ manutencao.preco_total }}" class="form-control" placeholder="0.00">
                </div>

                <!-- Fotos Existentes -->
                {% if manutencao.fotos %}
                <div class="form-group">
                    <label>üì∑ Fotos Atuais</label>
                    <div class="existing-photos">
                        {% for foto in manutencao.fotos %}
                        <div class="photo-item">
                            <img src="/uploads/{{ foto.nome_arquivo }}" alt="Foto {{ loop.index }}" class="existing-photo">
                            <span class="photo-name">{{ foto.nome_arquivo }}</span>
                        </div>
                        {% endfor %}
                    </div>
                    <small class="text-muted">As fotos atuais ser√£o mantidas. Para adicionar novas fotos, use o campo abaixo.</small>
                </div>
                {% endif %}

                <!-- Novas Fotos -->
                <div class="form-group">
                    <label for="fotos">üì∑ Adicionar Novas Fotos</label>
                    <div class="upload-area" onclick="document.getElementById('fotos').click()">
                        <input type="file" id="fotos" name="fotos" multiple accept="image/*" style="display: none;">
                        <div class="upload-content">
                            <span class="upload-icon">üì∑</span>
                            <p>Clique para adicionar fotos ou arraste aqui</p>
                            <small>Formatos: JPG, PNG, GIF (m√°x. 5MB cada)</small>
                        </div>
                    </div>
                    <div id="photo-preview" class="photo-preview"></div>
                </div>

                <!-- Bot√µes -->
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        üíæ Salvar Altera√ß√µes
                    </button>
                    <a href="{{ url_for('detalhes_manutencao', manutencao_id=manutencao.id) }}" class="btn btn-secondary">
                        ‚ùå Cancelar
                    </a>
                    <a href="{{ url_for('listar_manutencoes') }}" class="btn btn-secondary">
                        üìã Voltar para Lista
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

{% block extra_css %}
<style>
    .existing-photos {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: var(--space-md);
        margin-bottom: var(--space-md);
    }

    .photo-item {
        text-align: center;
        background: var(--gray-50);
        border-radius: var(--radius-md);
        padding: var(--space-sm);
        border: 1px solid var(--color-border);
    }

    .existing-photo {
        width: 100%;
        height: 80px;
        object-fit: cover;
        border-radius: var(--radius-sm);
        margin-bottom: var(--space-xs);
    }

    .photo-name {
        font-size: var(--font-size-xs);
        color: var(--color-text-secondary);
        word-break: break-all;
    }

    .form-actions {
        display: flex;
        gap: var(--space-md);
        flex-wrap: wrap;
        margin-top: var(--space-lg);
    }

    @media (max-width: 768px) {
        .form-actions {
            flex-direction: column;
        }
        
        .existing-photos {
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // Preview de fotos
    document.getElementById('fotos').addEventListener('change', function(e) {
        const preview = document.getElementById('photo-preview');
        preview.innerHTML = '';
        
        const files = Array.from(e.target.files);
        
        files.forEach((file, index) => {
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const photoDiv = document.createElement('div');
                    photoDiv.className = 'preview-photo';
                    photoDiv.innerHTML = `
                        <img src="${e.target.result}" alt="Preview ${index + 1}">
                        <span>${file.name}</span>
                        <button type="button" onclick="this.parentElement.remove()" class="remove-photo">√ó</button>
                    `;
                    preview.appendChild(photoDiv);
                };
                reader.readAsDataURL(file);
            }
        });
    });

    // Drag and drop
    const uploadArea = document.querySelector('.upload-area');
    
    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.style.background = 'var(--primary-50)';
    });
    
    uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadArea.style.background = '';
    });
    
    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadArea.style.background = '';
        
        const files = e.dataTransfer.files;
        document.getElementById('fotos').files = files;
        
        // Trigger change event
        const event = new Event('change', { bubbles: true });
        document.getElementById('fotos').dispatchEvent(event);
    });
</script>
{% endblock %}
{% endblock %}
