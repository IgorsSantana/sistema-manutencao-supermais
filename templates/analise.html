{% extends "base.html" %}

{% block title %}An√°lise de Manuten√ß√µes - Sistema de Manuten√ß√£o{% endblock %}

{% block header_title %}An√°lise de Manuten√ß√µes{% endblock %}

{% block content %}
<!-- ===== FILTROS DE AN√ÅLISE ===== -->
<div class="card mb-lg">
    <div class="card-header">
        <h3>üìä Filtros de An√°lise</h3>
    </div>
    <div class="card-body">
        <form method="GET" action="{{ url_for('analise') }}" class="form-grid">
            <div class="form-group">
                <label for="data_inicio">üìÖ Data In√≠cio</label>
                <input type="date" id="data_inicio" name="data_inicio" 
                       value="{{ filtros.data_inicio or '' }}" 
                       class="form-control">
            </div>
            
            <div class="form-group">
                <label for="data_fim">üìÖ Data Fim</label>
                <input type="date" id="data_fim" name="data_fim" 
                       value="{{ filtros.data_fim or '' }}" 
                       class="form-control">
            </div>
            
            <div class="form-group">
                <label for="tipo">üè∑Ô∏è Tipo de Manuten√ß√£o</label>
                <select id="tipo" name="tipo" class="form-control">
                    <option value="todas" {% if filtros.tipo == 'todas' %}selected{% endif %}>
                        Todas as Manuten√ß√µes
                    </option>
                    <option value="loja" {% if filtros.tipo == 'loja' %}selected{% endif %}>
                        üè™ Apenas Lojas
                    </option>
                    <option value="veiculo" {% if filtros.tipo == 'veiculo' %}selected{% endif %}>
                        üöó Apenas Ve√≠culos
                    </option>
                </select>
            </div>
            
            <div class="form-group">
                <button type="submit" class="btn btn-primary">
                    üîç Aplicar Filtros
                </button>
                <a href="{{ url_for('analise') }}" class="btn btn-secondary">
                    üóëÔ∏è Limpar Filtros
                </a>
            </div>
        </form>
    </div>
</div>

<!-- ===== RESUMO EXECUTIVO ===== -->
<div class="stats-grid mb-lg">
    <div class="stat-card">
        <div class="stat-number">{{ resumo.total_manutencoes }}</div>
        <div class="stat-label">Total de Manuten√ß√µes</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-number">R$ {{ "%.2f"|format(resumo.total_gasto) }}</div>
        <div class="stat-label">Valor Total Gasto</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-number">{{ resumo.manutencoes_loja }}</div>
        <div class="stat-label">Manuten√ß√µes em Lojas</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-number">{{ resumo.manutencoes_veiculo }}</div>
        <div class="stat-label">Manuten√ß√µes em Ve√≠culos</div>
    </div>
</div>

<!-- ===== AN√ÅLISE POR TIPO ===== -->
<div class="card mb-lg">
    <div class="card-header">
        <h3>üìà An√°lise por Tipo</h3>
    </div>
    <div class="card-body">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number">R$ {{ "%.2f"|format(resumo.gasto_loja) }}</div>
                <div class="stat-label">Gasto com Lojas</div>
                <div class="text-muted">
                    {{ "%.1f"|format((resumo.gasto_loja / resumo.total_gasto * 100) if resumo.total_gasto > 0 else 0) }}% do total
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-number">R$ {{ "%.2f"|format(resumo.gasto_veiculo) }}</div>
                <div class="stat-label">Gasto com Ve√≠culos</div>
                <div class="text-muted">
                    {{ "%.1f"|format((resumo.gasto_veiculo / resumo.total_gasto * 100) if resumo.total_gasto > 0 else 0) }}% do total
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ===== AN√ÅLISE POR LOJA ===== -->
{% if lojas_analise %}
<div class="card mb-lg">
    <div class="card-header">
        <h3>üè™ An√°lise por Loja</h3>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>Loja</th>
                        <th>Manuten√ß√µes</th>
                        <th>Valor Gasto</th>
                        <th>M√©dia por Manuten√ß√£o</th>
                    </tr>
                </thead>
                <tbody>
                    {% for loja, dados in lojas_analise.items() %}
                    <tr>
                        <td><strong>{{ loja }}</strong></td>
                        <td>{{ dados.total }}</td>
                        <td>R$ {{ "%.2f"|format(dados.gasto) }}</td>
                        <td>R$ {{ "%.2f"|format(dados.gasto / dados.total) if dados.total > 0 else 0 }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<!-- ===== AN√ÅLISE POR VE√çCULO ===== -->
{% if veiculos_analise %}
<div class="card mb-lg">
    <div class="card-header">
        <h3>üöó An√°lise por Ve√≠culo</h3>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>Placa</th>
                        <th>Manuten√ß√µes</th>
                        <th>Valor Gasto</th>
                        <th>M√©dia por Manuten√ß√£o</th>
                    </tr>
                </thead>
                <tbody>
                    {% for placa, dados in veiculos_analise.items() %}
                    <tr>
                        <td><strong>{{ placa }}</strong></td>
                        <td>{{ dados.total }}</td>
                        <td>R$ {{ "%.2f"|format(dados.gasto) }}</td>
                        <td>R$ {{ "%.2f"|format(dados.gasto / dados.total) if dados.total > 0 else 0 }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<!-- ===== AN√ÅLISE MENSAL ===== -->
{% if manutencoes_mensais %}
<div class="card mb-lg">
    <div class="card-header">
        <h3>üìÖ An√°lise Mensal</h3>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>M√™s/Ano</th>
                        <th>Manuten√ß√µes</th>
                        <th>Valor Gasto</th>
                        <th>M√©dia por Manuten√ß√£o</th>
                    </tr>
                </thead>
                <tbody>
                    {% for mes, dados in manutencoes_mensais.items() %}
                    <tr>
                        <td><strong>{{ mes }}</strong></td>
                        <td>{{ dados.total }}</td>
                        <td>R$ {{ "%.2f"|format(dados.gasto) }}</td>
                        <td>R$ {{ "%.2f"|format(dados.gasto / dados.total) if dados.total > 0 else 0 }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<!-- ===== AN√ÅLISE POR PRIORIDADE REMOVIDA ===== -->

<!-- ===== MANUTEN√á√ïES RECENTES ===== -->
{% if manutencoes %}
<div class="card">
    <div class="card-header">
        <h3>üìã Manuten√ß√µes Recentes</h3>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Tipo</th>
                        <th>Descri√ß√£o</th>
                        <th>Valor</th>
                    </tr>
                </thead>
                <tbody>
                    {% for manutencao in manutencoes %}
                    <tr>
                        <td>{{ manutencao.data_manutencao.strftime('%d/%m/%Y') }}</td>
                        <td>
                            {% if manutencao.tipo == 'loja' %}
                                üè™ {{ manutencao.loja.nome if manutencao.loja else 'Loja n√£o encontrada' }}
                            {% else %}
                                üöó {{ manutencao.veiculo.placa if manutencao.veiculo else 'Ve√≠culo n√£o encontrado' }}
                            {% endif %}
                        </td>
                        <td>{{ manutencao.descricao[:50] }}{% if manutencao.descricao|length > 50 %}...{% endif %}</td>
                        <td>R$ {{ "%.2f"|format(manutencao.preco_total) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block extra_css %}
<style>
    /* ===== AN√ÅLISE SPECIFIC STYLES ===== */
    
    .table {
        width: 100%;
        border-collapse: collapse;
        margin-top: var(--space-md);
    }
    
    .table th,
    .table td {
        padding: var(--space-sm) var(--space-md);
        text-align: left;
        border-bottom: 1px solid var(--color-border);
    }
    
    .table th {
        background-color: var(--gray-50);
        font-weight: var(--font-weight-semibold);
        color: var(--color-text);
        font-size: var(--font-size-sm);
    }
    
    .table td {
        font-size: var(--font-size-sm);
    }
    
    .table tbody tr:hover {
        background-color: var(--gray-50);
    }
    
    .table-responsive {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
    
    /* Mobile optimizations */
    @media (max-width: 768px) {
        .table {
            font-size: var(--font-size-xs);
        }
        
        .table th,
        .table td {
            padding: var(--space-xs) var(--space-sm);
        }
        
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-md);
        }
    }
    
    @media (max-width: 480px) {
        .stats-grid {
            grid-template-columns: 1fr;
        }
        
        .table th,
        .table td {
            padding: var(--space-xs);
            font-size: 0.75rem;
        }
    }
</style>
{% endblock %}
